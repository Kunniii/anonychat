<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AnonyChat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @font-face {
      /* Thanks for the authors of Maple Mono fonts */
      /* https://github.com/subframe7536/maple-font */
      font-family: 'Maple Mono';
      src: url('/fonts/MapleMono.ttf') format('truetype');
      font-display: swap;
    }

    * {
      font-family: 'Maple Mono', monospace !important;
    }

    /* Hide scrollbar for Chrome, Safari and Opera */
    #log::-webkit-scrollbar {
      width: 6px;
    }

    #log::-webkit-scrollbar-track {
      background: transparent;
    }

    #log::-webkit-scrollbar-thumb {
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    /* Firefox */
    #log {
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.1) transparent;
    }

    /* Mobile adjustments */
    @media (max-width: 768px) {
      body {
        height: 100vh;
        height: 100dvh;
        overflow: hidden;
      }
      
      .chat-container {
        height: 100vh;
        height: 100dvh;
        max-height: 100vh;
        max-height: 100dvh;
      }
      
      #log {
        height: calc(100vh - 140px);
        height: calc(100dvh - 140px);
      }
    }
  </style>
  <audio id="connect-sound" src="/sounds/activity.mp3" preload="auto"></audio>
  <audio id="disconnect-sound" src="/sounds/activity.mp3" preload="auto"></audio>
  <audio id="send-sound" src="/sounds/message.mp3" preload="auto"></audio>
  <audio id="receive-sound" src="/sounds/message.mp3" preload="auto"></audio>
</head>

<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen font-[Maple Mono] p-0 md:p-4">
  <div class="chat-container w-full max-w-md md:max-w-lg lg:max-w-xl p-4 md:p-6 space-y-3 bg-gray-800 md:rounded-lg md:shadow-lg">
    <h1 class="text-lg md:text-xl font-semibold text-center text-purple-300">AnonyChat</h1>
    <div id="log" class="h-64 md:h-80 lg:h-96 overflow-y-auto bg-gray-700 rounded p-2 md:p-3 text-sm space-y-1"></div>
    <div id="typing" class="text-gray-400 text-xs h-4 pl-1"></div>
    <input id="msg" type="text"
      class="w-full px-3 py-2 md:py-3 rounded bg-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-400 text-sm md:text-base"
      placeholder="Type a message..." autocomplete="off" />
  </div>

  <script>
    const log = document.getElementById('log');
    const typingEl = document.getElementById('typing');
    const input = document.getElementById('msg');
    const ws = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}`);

    let lastSent = "";
    let isConnected = false;

    // Function to clear all chat bubbles
    const clearChat = () => {
      const bubbles = log.querySelectorAll('.chat-bubble');
      bubbles.forEach(bubble => bubble.remove());
    };

    ws.onmessage = (e) => {
      let msg;
      try { msg = JSON.parse(e.data); } catch { msg = { system: e.data }; }

      if (msg.system?.includes('Connected to a stranger')) {
        isConnected = true;
        clearChat(); // Clear previous chat when new user connects
        document.getElementById('connect-sound')?.play();
      }
      if (msg.system?.includes('disconnected')) {
        isConnected = false;
        document.getElementById('disconnect-sound')?.play();
      }
      if (msg.type === 'text') {
        const soundId = msg.from === 'self' ? 'send-sound' : 'receive-sound';
        document.getElementById(soundId)?.play();
      }

      if (msg.type === 'text') {
        const isMine = msg.data === lastSent;
        const bubble = document.createElement('div');
        bubble.className = `chat-bubble max-w-[85%] md:max-w-[75%] w-fit px-3 py-2 my-1 rounded-lg text-sm md:text-base break-words ${isMine
          ? 'ml-auto bg-blue-500 text-white text-right'
          : 'mr-auto bg-gray-600 text-white text-left'
          }`;
        bubble.textContent = msg.data;
        log.appendChild(bubble);
        log.scrollTop = log.scrollHeight;
      }

      if (msg.type === 'typing') {
        typingEl.textContent = 'Stranger is typingâ€¦';
        clearTimeout(typingEl._clear);
        typingEl._clear = setTimeout(() => typingEl.textContent = '', 2000);
      }

      if (msg.system) {
        const sys = document.createElement('div');
        sys.className = 'text-gray-400 italic text-xs md:text-sm my-1 text-center';
        sys.textContent = msg.system;
        log.appendChild(sys);
        log.scrollTop = log.scrollHeight;
      }
    };

    let typingTimeout;
    const sendTyping = () => {
      if (ws.readyState === WebSocket.OPEN && isConnected) {
        ws.send(JSON.stringify({ type: 'typing' }));
      }
    };
    const debounceTyping = () => {
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(sendTyping, 300);
    };

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && input.value.trim()) {
        lastSent = input.value;
        if (ws.readyState === WebSocket.OPEN && isConnected) {
          ws.send(JSON.stringify({ type: 'text', data: input.value }));
        }
        input.value = '';
      } else {
        debounceTyping();
      }
    });

    // Prevent zoom on iOS when focusing input
    input.addEventListener('touchstart', (e) => {
      input.style.fontSize = '16px';
    });

    const handleResize = () => {
      if (window.innerWidth <= 768) {
        document.body.style.height = window.innerHeight + 'px';
      }
    };

    window.addEventListener('resize', handleResize);
    window.addEventListener('orientationchange', () => {
      setTimeout(handleResize, 100);
    });


    handleResize();
  </script>
</body>

</html>